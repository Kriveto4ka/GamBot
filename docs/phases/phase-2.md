# Этап 2: Управление задачами

## Цель

По завершении этапа должны работать:
- Кнопка **«Новая задача»** → пошаговый процесс (название → сложность → дедлайн)
- Кнопка **«Мои задачи»** → список активных задач кнопками
- Детали задачи → кнопки **«Выполнено»** / **«Удалить»**, возврат к списку

На этапе 2 **не начисляется XP** за выполнение и **не наносится урон** за просрочку — только CRUD задач и навигация. Игровая механика — этап 3.

## Входные условия

- Этап 1 выполнен: /start, главное меню, экран персонажа
- PostgreSQL, модель User
- Токен и БД настроены

## Требования из SPEC

| ID | Описание |
|----|----------|
| R1 | Создать задачу: название (обязательно, до 200 символов), сложность (4 варианта), дедлайн (обязательно) |
| R2 | Просмотр списка активных задач: название, сложность, дедлайн, оставшееся время |
| R3 | Отметить задачу как выполненную (на этапе 2 — только смена статуса, без XP) |
| R4 | Удалить задачу без XP и урона |
| R5 | Просмотр списка просроченных задач (кнопка «Просроченные») |
| R14 | «Новая задача» — пошагово: 1) ввод названия текстом, 2) кнопки сложности, 3) быстрый выбор дедлайна + ввод вручную |
| R15 | Кнопки быстрого выбора дедлайна (см. решения — явные формулировки времени) |
| R16 | «Мои задачи» — список кнопками; клик по задаче — детали с кнопками «Выполнено» / «Удалить» и «Назад» |
| R19 | Все экраны — кнопка «Назад» или «Меню» |
| R20 | Ручной ввод дедлайна: «завтра 18:00», «25.01 15:30», «25.01.2025 15:30», «через 2 часа», «через 1 день» |

## Граничные случаи (SPEC 5)

| ID | Описание |
|----|----------|
| E1 | Дедлайн в прошлом — отклонить с сообщением об ошибке |
| E2 | Пустое название — отклонить с сообщением |
| E3 | Название длиннее 200 символов — обрезать и уведомить |
| E4 | Некорректный формат даты — запросить повторный ввод с примерами |
| E6 | Задача не существует — сообщение об ошибке |
| E7 | Нет активных задач — информативное сообщение |

## Структура данных (SPEC 7.2, 7.3)

### Task

| Поле | Тип | Описание |
|------|-----|----------|
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ на User |
| title | String(200) | Название |
| difficulty | Enum | easy, medium, hard, epic |
| deadline | DateTime | Дедлайн |
| status | Enum | active, completed, failed, deleted |
| created_at | DateTime | Дата создания |
| completed_at | DateTime | Дата выполнения (null если не выполнена) |

### Константы сложности (для отображения и этапа 3)

| Difficulty | XP | Damage |
|------------|-----|--------|
| easy | 10 | 5 |
| medium | 25 | 15 |
| hard | 50 | 30 |
| epic | 100 | 50 |

## Экраны и сообщения (SPEC 8)

- **8.5** Список задач — заголовок «Твои задачи (N)», кнопки по задачам, «Просроченные», «Меню»
- **8.6** Детали задачи — название, сложность, дедлайн, осталось; кнопки «Выполнено», «Удалить», «К задачам»
- **8.7** Создание — шаг 1: «Введи название задачи», кнопка «Отмена»
- **8.8** Создание — шаг 2: название + кнопки сложности (Лёгкая +10 XP и т.д.), «Отмена»
- **8.9** Создание — шаг 3: название, сложность, «Когда дедлайн?» — быстрые кнопки + «Ввести вручную», «Отмена»
- **8.10** Задача создана — подтверждение, «Ещё задачу» / «Меню»

По решениям (docs/decisions.md): быстрые кнопки — с явным временем, например «Сегодня 21:00», «Завтра 10:00», «Завтра 18:00», «Через 1ч», «Через 3ч», «Ввести».

## Компоненты

- Модель **Task**, миграция (create_all)
- **Репозиторий задач**: создание, список активных, список просроченных, get по id, выполнить, удалить
- **Парсер дат** (R20 + E1, E4): валидация «в будущем», форматы из SPEC
- **FSM** создания задачи: состояние (title → difficulty → deadline), отмена
- Обработчики: task:new (старт FSM), ввод названия, callback сложность, callback/текст дедлайн, сохранение задачи
- Обработчики: task:list (список или E7), task:detail:<id>, task:done:<id>, task:del:<id>, task:failed (просроченные)
- Тексты и клавиатуры для 8.5–8.10
- Интеграция: главное меню и экран персонажа показывают реальное число активных задач и ближайший дедлайн

## Критерии готовности

- [ ] «Новая задача» запускает пошаговый процесс; можно отменить на любом шаге
- [ ] Название: пустое — ошибка (E2), >200 — обрезка + уведомление (E3)
- [ ] Сложность выбирается кнопками (4 варианта)
- [ ] Дедлайн: быстрые кнопки и ручной ввод; прошлое — ошибка (E1), неверный формат — повтор с примерами (E4)
- [ ] «Мои задачи»: список кнопками или сообщение «Нет активных задач» (E7)
- [ ] Клик по задаче — детали; «Выполнено» помечает выполненной (без XP), «Удалить» — удаляет (R4)
- [ ] «Просроченные» — список просроченных задач (R5)
- [ ] В главном меню отображается число активных задач; на экране персонажа — число задач и ближайший дедлайн
- [ ] Данные задач сохраняются в БД (NR4)
